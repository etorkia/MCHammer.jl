using DataFrames, StatsBase, Statistics, Plots

# ── helpers ───────────────────────────────────────────────────────────────────
function build_levels(var::Symbol, base_val;
                      mode::Symbol=:percentiles, points::Int=5,
                      lo::Float64=0.10, hi::Float64=0.90,
                      dev_lo::Float64=-0.20, dev_hi::Float64=0.20,
                      samples::Union{Nothing,AbstractVector}=nothing)
    if mode === :percentiles
        @assert samples !== nothing "In :percentiles mode pass samples[!, $(var)]."
        qs = collect(range(lo, hi; length=points))
        return [quantile(samples, q) for q in qs], qs .* 100
    elseif mode === :deviations
        ds = collect(range(dev_lo, dev_hi; length=points))
        return [base_val * (1 + d) for d in ds], ds .* 100
    else
        error("Unknown mode: $mode")
    end
end

function oneway_sensitivity(f, base::NamedTuple;
                            variables=nothing,
                            mode::Symbol=:percentiles, points::Int=5,
                            lo::Float64=0.10, hi::Float64=0.90,
                            dev_lo::Float64=-0.20, dev_hi::Float64=0.20,
                            samples::Union{Nothing,DataFrame}=nothing)
    vars = variables === nothing ? collect(keys(base)) : Symbol.(collect(variables))
    base_y = f(base)

    trows = NamedTuple[]
    srows = NamedTuple[]

    for v in vars
        bval = getfield(base, v)
        sampcol = (mode === :percentiles && samples !== nothing && hasproperty(samples, v)) ?
                  samples[!, v] : nothing

        levels, xdisp = build_levels(v, bval; mode, points, lo, hi, dev_lo, dev_hi, samples=sampcol)

        yvals = Float64[]
        for (x, xd) in zip(levels, xdisp)
            y = f((; base..., (v=>x)...))  # update one field in the NamedTuple
            push!(yvals, y)
            push!(srows, (var=v, xlevel=xd, yforecast=y, base=base_y,
                          xlabel=(mode===:deviations ? "% Δ in $v" : "Percentile of $v")))
        end

        downside = first(yvals)
        upside   = last(yvals)
        rng      = abs(upside - downside)
        push!(trows, (var=v, downside=downside, upside=upside, base=base_y, range=rng))
    end

    tornado_df = DataFrame(trows) |> df -> sort(df, :range, rev=true)
    spider_df  = DataFrame(srows)
    return (tornado_df=tornado_df, spider_df=spider_df)
end

# ── plotting ──────────────────────────────────────────────────────────────────
function plot_tornado(df::DataFrame; title="Tornado", top::Union{Nothing,Int}=nothing)
    tdf = top === nothing ? deepcopy(df) : first(df, top)
    downΔ = tdf.downside .- tdf.base
    upΔ   = tdf.upside   .- tdf.base
    y = collect(1:nrow(tdf))

    p = bar(y, downΔ; orientation=:horizontal, label="Downside", color=:orange, bar_width=0.6)
    bar!(p, y, upΔ; orientation=:horizontal, label="Upside", color=:deepskyblue, bar_width=0.6)
    plot!(p, yticks=(y, string.(tdf.var)))
    vline!(p, [0.0]; color=:gray, linestyle=:dash, label="")
    xlabel!(p, "Δ Forecast vs Base")
    ylabel!(p, "Input")
    title!(p, title)
    return p
end

function plot_spider(df::DataFrame; title="Spider", group_limit::Union{Nothing,Int}=nothing)
    xlabs = unique(df.xlabel); xlab = isempty(xlabs) ? "" : first(xlabs)
    spread = combine(groupby(df, :var)) do g
        (; var=first(g.var), sp=maximum(g.yforecast) - minimum(g.yforecast))
    end
    sort!(spread, :sp, rev=true)
    vars_ordered = group_limit === nothing ? spread.var : first(spread, group_limit).var

    p = plot(title=title, xlabel=xlab, ylabel="Forecast", legend=:outerright)
    for v in vars_ordered
        g = df[df.var .== v, :]
        plot!(p, g.xlevel, g.yforecast; label=String(v))
    end
    if nrow(df) > 0
        hline!(p, [first(df.base)]; color=:gray, linestyle=:dash, label="Base")
    end
    return p
end

# ── user-facing wrappers ──────────────────────────────────────────────────────
function tornado_chart(f, base::NamedTuple; variables=nothing,
                       mode::Symbol=:percentiles, points::Int=5,
                       lo::Float64=0.10, hi::Float64=0.90,
                       dev_lo::Float64=-0.20, dev_hi::Float64=0.20,
                       samples::Union{Nothing,DataFrame}=nothing,
                       top::Union{Nothing,Int}=nothing,
                       title::AbstractString="Tornado")
    res = oneway_sensitivity(f, base; variables, mode, points, lo, hi, dev_lo, dev_hi, samples)
    p   = plot_tornado(res.tornado_df; title=title, top=top)
    return p, res.tornado_df
end

function spider_chart(f, base::NamedTuple; variables=nothing,
                      mode::Symbol=:percentiles, points::Int=5,
                      lo::Float64=0.10, hi::Float64=0.90,
                      dev_lo::Float64=-0.20, dev_hi::Float64=0.20,
                      samples::Union{Nothing,DataFrame}=nothing,
                      group_limit::Union{Nothing,Int}=nothing,
                      title::AbstractString="Spider")
    res = oneway_sensitivity(f, base; variables, mode, points, lo, hi, dev_lo, dev_hi, samples)
    p   = plot_spider(res.spider_df; title=title, group_limit=group_limit)
    return p, res.spider_df
end

